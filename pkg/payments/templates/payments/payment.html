<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>JoyXpress - Secure Payment</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://js.paystack.co/v1/inline.js"></script>
</head>

<body>
    <div class="container-fluid py-5">
        <div class="container">
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h1 class="display-4 text-success">
                        <i class="fa fa-lock mr-2"></i> Secure Payment
                    </h1>
                    <p class="lead text-muted">You are one step away from confirming your shipment.</p>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-6">
                    <div class="card shadow border-0">
                        <div class="card-header bg-success text-white">
                            <h4 class="mb-0">Payment Details</h4>
                        </div>
                        <div class="card-body text-center">
                            
                            <h2 class="mb-3">
                                Amount Due: <span class="text-danger">
                                    ₦{{ "{:,.2f}".format(shipment.calculated_amount) }}
                                </span>
                            </h2>
                            <p class="text-muted">
                                **Reference ID:** {{ shipment.tracking_number }}
                            </p>
                            <p class="text-muted small">
                                Charged to: **{{ u.email }}**
                            </p>
                            <hr>

                            <button type="button" class="btn btn-primary btn-lg px-5" id="paystack-button">
                                Pay Now (₦{{ "{:,.2f}".format(shipment.calculated_amount) }})
                            </button>
                            
                            <p class="mt-3 text-muted small">
                                By clicking 'Pay Now', you agree to our <a href="#">Terms of Service</a>.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    
    <script>
        $(document).ready(function() {

            // --- IMPORTANT: REPLACE WITH YOUR ACTUAL PAYSTACK PUBLIC KEY ---
            // Ideally, this key should be passed from Flask config, not hardcoded.
            const PAYSTACK_PUBLIC_KEY = 'PAYSTACK_PUBLIC_KEY_HERE'; 
            
            // Data passed from Flask's initiate_payment route
            const paymentData = {
                amount: {{ payment_data.amount | tojson }},       // in kobo (e.g., 500000 for ₦5,000.00)
                email: {{ payment_data.email | tojson }},         
                reference: {{ payment_data.reference | tojson }}, 
                callback_url: {{ payment_data.callback_url | tojson }} // URL for Paystack to return to
            };

            $('#paystack-button').click(function() {
                var handler = PaystackPop.setup({
                    key: PAYSTACK_PUBLIC_KEY,
                    email: paymentData.email,
                    amount: paymentData.amount,
                    ref: paymentData.reference,
                    // If the user closes the modal, we don't do anything specific yet.

                    callback: function(response){
                        // Payment was successful (user closed the modal)
                        // Redirect to the callback URL with the transaction reference
                        const redirectUrl = paymentData.callback_url + '?reference=' + response.reference;
                        window.location.href = redirectUrl;
                    },

                    onClose: function(){
                        // User cancelled the payment
                        alert('Payment cancelled. You can try again.');
                        // Optionally redirect back to the confirmation page
                    }
                });
                
                // Open the payment modal
                handler.openIframe();
            });
        });
    </script>
    
    </body>

</html>